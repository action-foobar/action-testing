name: PR - check user, lint , add user
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TERRAFORM_BASE_PATH: ./terraform/user
on:
  pull_request:
    paths:
      - "people.csv"
  push:
jobs:
  check_user:
    name: check_user
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          git fetch --no-tags --prune --depth=1 origin +refs/heads/*:refs/remotes/origin/*
      - run: |
          echo "::set-output diff=csvdiff::$(git diff origin/test:people.csv HEAD:people.csv --unified=0 | egrep "^\+" | grep -v "people.csv" | tr -d "+")"
      - run: |
          git diff origin/test:people.csv HEAD:people.csv --unified=0 | { egrep -s  "^\+" || true; } | { grep -v "people.csv" || true; } | tr -d "+" &>/tmp/output.csv
      - run: ./check.sh /tmp/output.csv ${{ secrets.GITHUB_TOKEN }}
        shell: bash
  lint:
    needs: ["check_user"]
    runs-on: ubuntu-latest
    name: Validate terraform configuration

    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: terraform fmt
        uses: dflook/terraform-fmt-check@v1
        with:
          path: ${{ env.TERRAFORM_BASE_PATH }}
      - name: Run Checkov action
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ${{ env.TERRAFORM_BASE_PATH }}
          soft_fail: true
  plan:
    needs: ["lint"]
    runs-on: ubuntu-latest
    name: Plan users
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: terraform plan
        uses: dflook/terraform-plan@v1
        with:
          path: ${{ env.TERRAFORM_BASE_PATH }}
          label: users